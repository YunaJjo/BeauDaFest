<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="reservation">
	
	<!-- 예약 리스트 조회 -->
	<!-- 옵션 null : total 금액 -> null 수정 필요 -->
	<select id = "selectRsvnList" resultType="java.util.HashMap">
	
		select rsvnnum, memberid, membername, memberphone, 
			RESERVATION2.designname designname,nvl(SHOPDESIGN2.designname,'선택없음') optionname,
			bookingdate, rsvndate, RESERVATION2.shopnum,
			RESERVATION2.designprice +nvl(SHOPDESIGN2.designprice,0) designprice 
			
		from
			(select rsvnnum, memberid, membername, shopdesign.designname designname, optionnum,
					 shopdesign.designprice designprice, 
					bookingdate, rsvndate, memberphone, RESERVATION.shopnum shopnum
			
			 from
					(select rsvnnum, memberid, membername, designid, designid2 optionnum, 
							bookingdate, rsvndate, memberphone, shopnum
	 	 			from reservation  inner join memberList 
	 				 using(memberid)
	 				 ) RESERVATION,  SHOPDESIGN
			where RESERVATION.designid = shopdesign.designid
			and RESERVATION.shopnum = #{shopnum}
			) reservation2 left outer join SHOPDESIGN SHOPDESIGN2
		ON reservation2.optionnum = SHOPDESIGN2.designid
		order by rsvnnum
	</select>
	
	
	<!-- 월별 예약수 조회 -->
	<select id = "monthlyRsvnCount" resultType="java.util.HashMap">
		
		select yearmonth.ym ym, nvl(cnt,0) cnt

		from (select to_char(add_months(to_date(#{fromDate}, 'YYYYMM'),(level - 1)), 'yyyy-mm') ym
 			 from dual
 			<![CDATA[
			 connect by add_months(to_date(#{fromDate}, 'YYYYMM'),(level - 1)) <= to_date(#{toDate}, 'YYYYMM')) yearmonth
	 		]]>
	 		
		 left outer join 
	 
			(select to_char(rsvndate, 'yyyy-mm') ym, count(*) cnt
			 from reservation  
			 where shopnum=#{shopnum}
			 group by to_char(rsvndate, 'yyyy-mm')) reservation
	 
		on yearmonth.ym = reservation.ym
		order by yearmonth.ym
		
	
	</select>
	
	
	<!-- 월별 금액수 -->
	
	
</mapper>
