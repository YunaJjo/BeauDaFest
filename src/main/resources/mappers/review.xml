<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="review">
	<!-- 한 샵의 전체 리뷰 조회 -->
	<select id="allReview">
		select reviewNum, memberId, shopNum, reviewScore, reviewComment, reviewDepth, reviewGroup, designName, memberName
		from (select reviewNum, memberId, shopNum, reviewScore, reviewComment, reviewDepth, reviewGroup, designName
			  from review join (select rsvnNum, designName
								from reservation join shopDesign 
				                using (designId)) 
			  using (rsvnNum)) join MEMBERLIST
		using(memberId)
		where shopNum=#{shopNum}
	</select>
	
	<!-- 샵 전체 평점 -->
	<select id="shopScore">
		select sum(reviewScore)/count(reviewScore) scoreAvg
		from review where shopNum=#{shopNum}
	</select>
	
	<!-- 예약 했던 & 리뷰X 유저만 댓글 등록 가능 -->
	<select id="checkRsvnAndReview">
		select count(*) from review
		where rsvnNum=#{rsvnNum} and (select bookingDate from reservation where rsvnNum=#{rsvnNum})<![CDATA[ < ]]>sysdate
	</select>
	
	
	<!-- 리뷰 추가 -->
	<insert id="addReview">
		insert into (reviewNum, memberId, shopNum, rsvnNum, reviewScore, reviewCommemt, reviewDepth, reviewGroup)
		values (#{reviewNum},#{memberId},#{shopNum}, #{rsvnNum},#{reviewScore},#{reviewCommemt},#{reviewDepth},#{reviewGroup})
	</insert>
</mapper>
